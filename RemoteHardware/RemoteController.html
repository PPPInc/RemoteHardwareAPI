<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="https://ppppublic.blob.core.windows.net/api/jquery.signalR-2.2.0.js"></script>
    <style>
        body {
            padding: 20px;
        }

        .error {
            color: red;
        }

        .wash {
            color: #83848A;
        }

        .word-break{
            -ms-word-break: break-all;
            word-break: break-all;

         /* Non standard for webkit */
             word-break: break-word;

            -webkit-hyphens: auto;
               -moz-hyphens: auto;
                -ms-hyphens: auto;
                    hyphens: auto;
        }

    </style>
</head>
<body>
    <div class="container-fluid">

        <div class="row">

            <div class="col-md-6">

                <div class="panel panel-default">

                    <div class="panel-heading"><h3 class="panel-title">Device Controller Emulator</h3></div>

                    <div class="panel-body">

                        <form class="form-inline">
                            <div class="form-group">
                                <label for="user-name"></label>
                                <input type="text" style="width: 350px;" class="form-control" id="user-name" placeholder="User Name" value="12045948-6B86-42AA-87E1-C77CC84CE173">
                            </div>
                            <button type="button" class="btn btn-default" id="connect">Connect</button>
                            <div class="form-group">
                                <label for="" style="margin: 10px 0 0 10px;" id="connected" class="error">You are not connected</label>
                            </div>
                        </form>

                        <form style="margin: 20px 0 0 0;">
                            <div class="form-group">
                                <label for="to">POS</label>
                                <input type="email" class="form-control" style="width: 350px;" id="to" placeholder="To">
                            </div>
                            <div class="form-group">
                                <label for="message">Result</label><br />
                                <textarea name="message" id="message" cols="80" rows="20" style="padding: 5px;">{"Action":"Result","TestMode":false,"Data":null,"ResultFields":{"ACCOUNT_DATA_TRUNCATED":"ACCOUNT_DATA_TRUNCATED","AMOUNT_BALANCE":"AMOUNT_BALANCE","AMOUNT_CASH_BACK":"AMOUNT_CASH_BACK","AMOUNT_FEE":"AMOUNT_FEE","AMOUNT_BILL":"AMOUNT_BILL","AMOUNT_TOTAL":"AMOUNT_TOTAL","AVS_RESPONSE_CODE":"AVS_RESPONSE_CODE","CVV_RESPONSE_CODE":"CVV_RESPONSE_CODE","REQUEST_ID":"REQUEST_ID","RESPONSE_TEXT":"RESPONSE_TEXT","APPROVAL_NUMBER":"APPROVAL_NUMBER","BATCH_ID":"BATCH_ID","BATCH_NUMBER":"BATCH_NUMBER","TRANSACTION_CODE":"TRANSACTION_CODE","ACCOUNT_CARD_TYPE":"ACCOUNT_CARD_TYPE","ACCOUNT_EXPIRATION_DATE":"ACCOUNT_EXPIRATION_DATE","BILLING_NAME":"BILLING_NAME","RESULT_MESSAGE":"RESULT_MESSAGE","RESULT_STATUS":"RESULT_STATUS","MERCHANT_NUMBER":"MERCHANT_NUMBER","LOCATIONID":"LocationID","eiVersion":null,"ResultStatus":true,"ResultMessage":"APPROVED","TransactionType":"CreditSale","Result":"","ApprovalNumberResult":"000000","CardNickname":"","BatchNumber":"","BillingName":"GLENN  WITT","AVSResponseCode":"","AVSResponseText":"","AuthorizationMode":"","CurrencyIndicator":"","AID":"A0000000031010","TVR":"0080008000","IAD":"","TSI":"E800","ARC":"","CardHolderVerificationMethod":"Signature","EMVOfflineData":"","ComputerDateTime":"0001-01-01T00:00:00","TerminalDateTime":"0001-01-01T00:00:00","ComputerTimeZoneOffset":0,"CVMCode":6,"Receipt":"x___________________________________\r\nGLENN  WITT\r\n\r\nI AGREE TO PAY THE BELOW\r\nTOTAL AMOUNT ACCORDING\r\nTO CARD ISSUER\r\nAGREEMENT\r\n\r\n************4223 VS\r\nEntryMethod:Chipped\r\nApproval:000000\r\nBatchNo.:\r\nCreditSale\r\nAmountTotal:168.45\r\nAID:A0000000031010\r\nTVR:0080008000\r\nTSI:E800\r\nCVM:Signature\r\n","CVVResponseCode":"","CVVResponseText":"","AmountBalance":0,"AmountCashBack":0,"AmountBill":0,"AmountFee":0,"AmountProcessed":168.45,"AmountTipped":0,"AccountCardType":"VS","safeMaskedAccount":"************4223","MaskedAccount":"************4223","AccountEntryMethod":"Chipped","UniqueTransID":"105a5da1a3","Signature":"MT30:MCw2NTUzNV4zNCw1Nl4zNyw1N140MCw2MF40NCw2MV40Nyw2Ml41MCw2NF41Myw2Nl41Niw2Nl42MCw2N142Myw2OF42Niw2OF42OSw2OF43Miw2OF43Niw2OF43OSw2N144Miw2Nl44NSw2Nl44OCw2M145Miw2MV45NSw1N145OCw1NV4xMDEsNTNeMTA0LDUxXjEwOCw0OF4xMTEsNDVeMTE0LDQ0XjExNyw0MV4xMjAsMzleMTI0LDM2XjEyNywzNF4xMzAsMzNeMTMzLDMzXn4=","DeviceBatchNumber":"","receiptFields":{"LicenseName":"","StoreName":"","MerchantNumber":"","StoreAddress1":"","StoreAddress2":"","CityStateZip":"","StorePhone":"","Footer1":"","Footer2":"","Footer3":"","UseTips":false,"UseFees":false,"UseLevel2":false},"AccountHash":"","AccountExpiryDate":"0520","AccountEntryType":"","MerchantId":"","LocationID":"","CancelPressed":false},"FormFields":null,"Message":null,"Success":true,"ErrorMessage":null,"UniqueTransId":null,"TransactionId":"00000000-0000-0000-0000-000000000000"}</textarea>
                            </div>
                            <button type="button" class="btn btn-default" id="send">Send</button>
                            <button type="button" class="btn btn-default" id="heartbeat">Heartbeat</button>
                            <span id="heartbeat-message" style="font-style: italic; margin-left: 10px;"></span>
                        </form>

                    </div>

                </div>

                <div class="panel panel-default">

                    <div class="panel-heading"><h3 class="panel-title"></h3></div>

                    <div class="panel-body">

                        <table class="table table-striped" id="messages">
                            <tr><th style="width: 150px;">From</th><th>Message</th></tr>
                        </table>

                    </div>

                </div>

                <button type="button" class="btn btn-default" id="clear">Clear</button>

            </div>

        </div>
    </div>

</body>

</html>

<script>

    function setFrom(control) {
        $("#to").val($(control).html());
        $("#message").focus();
    };

    $(function () {

        //$("#message").val('{"Action":"Result","TestMode":false,"Data":null,"ResultFields":{"ACCOUNT_DATA_TRUNCATED":"ACCOUNT_DATA_TRUNCATED","AMOUNT_BALANCE":"AMOUNT_BALANCE","AMOUNT_CASH_BACK":"AMOUNT_CASH_BACK","AMOUNT_FEE":"AMOUNT_FEE","AMOUNT_BILL":"AMOUNT_BILL","AMOUNT_TOTAL":"AMOUNT_TOTAL","AVS_RESPONSE_CODE":"AVS_RESPONSE_CODE","CVV_RESPONSE_CODE":"CVV_RESPONSE_CODE","REQUEST_ID":"REQUEST_ID","RESPONSE_TEXT":"RESPONSE_TEXT","APPROVAL_NUMBER":"APPROVAL_NUMBER","BATCH_ID":"BATCH_ID","BATCH_NUMBER":"BATCH_NUMBER","TRANSACTION_CODE":"TRANSACTION_CODE","ACCOUNT_CARD_TYPE":"ACCOUNT_CARD_TYPE","ACCOUNT_EXPIRATION_DATE":"ACCOUNT_EXPIRATION_DATE","BILLING_NAME":"BILLING_NAME","RESULT_MESSAGE":"RESULT_MESSAGE","RESULT_STATUS":"RESULT_STATUS","MERCHANT_NUMBER":"MERCHANT_NUMBER","LOCATIONID":"LocationID","eiVersion":null,"ResultStatus":true,"ResultMessage":"APPROVED","TransactionType":"CreditSale","Result":"","ApprovalNumberResult":"000000","CardNickname":"","BatchNumber":"","BillingName":"GLENN  WITT","AVSResponseCode":"","AVSResponseText":"","AuthorizationMode":"","CurrencyIndicator":"","AID":"A0000000031010","TVR":"0080008000","IAD":"","TSI":"E800","ARC":"","CardHolderVerificationMethod":"Signature","EMVOfflineData":"","ComputerDateTime":"0001-01-01T00:00:00","TerminalDateTime":"0001-01-01T00:00:00","ComputerTimeZoneOffset":0,"CVMCode":6,"Receipt":"x___________________________________\r\nGLENN  WITT\r\n\r\nI AGREE TO PAY THE BELOW\r\nTOTAL AMOUNT ACCORDING\r\nTO CARD ISSUER\r\nAGREEMENT\r\n\r\n************4223 VS\r\nEntryMethod:Chipped\r\nApproval:000000\r\nBatchNo.:\r\nCreditSale\r\nAmountTotal:168.45\r\nAID:A0000000031010\r\nTVR:0080008000\r\nTSI:E800\r\nCVM:Signature\r\n","CVVResponseCode":"","CVVResponseText":"","AmountBalance":0,"AmountCashBack":0,"AmountBill":0,"AmountFee":0,"AmountProcessed":168.45,"AmountTipped":0,"AccountCardType":"VS","safeMaskedAccount":"************4223","MaskedAccount":"************4223","AccountEntryMethod":"Chipped","UniqueTransID":"105a5da1a3","Signature":"MT30:MCw2NTUzNV4zNCw1Nl4zNyw1N140MCw2MF40NCw2MV40Nyw2Ml41MCw2NF41Myw2Nl41Niw2Nl42MCw2N142Myw2OF42Niw2OF42OSw2OF43Miw2OF43Niw2OF43OSw2N144Miw2Nl44NSw2Nl44OCw2M145Miw2MV45NSw1N145OCw1NV4xMDEsNTNeMTA0LDUxXjEwOCw0OF4xMTEsNDVeMTE0LDQ0XjExNyw0MV4xMjAsMzleMTI0LDM2XjEyNywzNF4xMzAsMzNeMTMzLDMzXn4=","DeviceBatchNumber":"","receiptFields":{"LicenseName":"","StoreName":"","MerchantNumber":"","StoreAddress1":"","StoreAddress2":"","CityStateZip":"","StorePhone":"","Footer1":"","Footer2":"","Footer3":"","UseTips":false,"UseFees":false,"UseLevel2":false},"AccountHash":"","AccountExpiryDate":"0520","AccountEntryType":"","MerchantId":"","LocationID":"","CancelPressed":false},"FormFields":null,"Message":null,"Success":true,"ErrorMessage":null,"UniqueTransId":null,"TransactionId":"00000000-0000-0000-0000-000000000000"}');

        $("#connect").on('click', function () {

            var userName = $("#user-name").val();

            if (userName === '') return;

            var connection = $.hubConnection('https://cloud.chargeitpro.com');

            //var connection = $.hubConnection('http://localhost:54769');

            connection.qs = { "userName": userName };

            var deviceHub = connection.createHubProxy('DeviceHub');

            deviceHub.on('send', function (from, message) {
                var d = new Date();
                $('#messages tr:last').after('<tr><td class="wash"><a href="#" onclick="setFrom(this);return false;" class="from">' + from + '</a></td><td class="word-break">'
                    + message + '<span style="float: right;" class="wash">' + d.getHours() + ':' + (d.getMinutes() < 10 ? '0' : '') + d.getMinutes() + '</span></td></tr>');
            });

            deviceHub.on('broadcast', function (message) {
                var d = new Date();
                $('#messages tr:last').after('<tr><td class="wash">broadcast</td><td>'
                    + message + '<span style="float: right;" class="wash">' + d.getHours() + ':' + (d.getMinutes() < 10 ? '0' : '') + d.getMinutes() + '</span></td></tr>');
            });

            deviceHub.on('error', function (message) {
                alert(message);
                $("#connected").html("You are not connected").addClass("error");
            });

            /* uncomment for verbose client side logging */
            //connection.logging = true;

            connection.start().done(function () {

                $("#send")
                    .off('click', function () { })
                    .on('click', function () {
                        deviceHub.invoke('send', $("#to").val(), $("#message").val());
                        //$("#message").val('');
                });

                $("#broadcast")
                    .off('click', function () { })
                    .on('click', function () {
                        deviceHub.invoke('broadcast', $("#message").val()).fail(function (error) {
                            console.log('broadcast error: ' + error)
                        });
                    });

                $("#heartbeat")
                    .off('click', function () { })
                    .on('click', function () {
                        $("#heartbeat-message").html("Added heartbeat at " + getDate()).hide().fadeIn("slow")
                        deviceHub.invoke('heartbeat', 'MyController', '123-ABC-456', 'MJsComputer', null).fail(function (error) {
                            console.log('broadcast error: ' + error)
                        });
                    });

                $("#connected").html("You are connected as: " + userName).removeClass("error");

                console.log(connection);

            }).fail(function (error) { console.log("Fail Error:" + error); });

            connection.error(function (error) {
                console.log('SignalR error: ' + error)
            });
        });

        $("#clear").click(function () {
            $("#messages").find("tr:gt(0)").remove();
        });

        function getDate() {

            var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            var d = new Date();
            var hr = d.getHours();
            var min = d.getMinutes();
            if (min < 10) {
                min = "0" + min;
            }
            var ampm = hr < 12 ? "am" : "pm";
            var date = d.getDate();
            var month = months[d.getMonth()];
            var year = d.getFullYear();
            return hr + ":" + min + ampm + " " + " on " + month + " " + date + ", " + year;
        }

    });
</script>